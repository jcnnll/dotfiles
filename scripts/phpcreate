#!/bin/sh
# vim: filetype=sh

export DOCKER_HOST=unix:///Users/jay/.lima/docker/sock/docker.sock

set -e

# -------- Docker via Lima Setup (Self-healing) --------
LIMA_PROFILE="docker"
LIMA_DOCKER_SOCKET="$HOME/.lima/${LIMA_PROFILE}/sock/docker.sock"

if ! docker info >/dev/null 2>&1; then
    echo "Docker not responding. Attempting to use Lima profile: $LIMA_PROFILE"

    if ! limactl list | grep -q "^$LIMA_PROFILE.*Running"; then
        echo "Starting Lima profile: $LIMA_PROFILE"
        limactl start "$LIMA_PROFILE" || {
            echo "Failed to start Lima profile '$LIMA_PROFILE'."
                exit 1
            }
        sleep 2
    fi

    if [ -S "$LIMA_DOCKER_SOCKET" ]; then
        export DOCKER_HOST="unix://$LIMA_DOCKER_SOCKET"
        echo "Using Lima Docker socket: $DOCKER_HOST"

        if ! docker info >/dev/null 2>&1; then
            echo "Docker still not responding after setting DOCKER_HOST."
            exit 1
        fi
    else
        echo "Lima Docker socket not found: $LIMA_DOCKER_SOCKET"
        exit 1
    fi
fi

PROJECTS_PATH="$HOME/workspace/github.com"

# -------- Colors --------
GREEN=$(tput setaf 2)
YELLOW=$(tput setaf 3)
NONE=$(tput sgr0)

# -------- Functions --------

seed_files() {
    cat > .env <<EOF
# .env
EOF
    mkdir public
    cat > public/index.php <<EOF
<?php
    phpinfo();
EOF

    cat > .gitignore <<EOF
vendor/
.env
.ddev/.dbimageBuild
EOF

    git init
}


create_project() {
    local project="$1"

    echo "${YELLOW}Creating Vanilla PHP project: ${project}${NONE}"

    cd "$PROJECTS_PATH"
    mkdir "$project"
    cd "$project"

    seed_files

    ddev config --project-type=php --docroot=public

    ddev start
    ddev auth ssh

    echo "${GREEN}âœ” Project '${project}' created and started.${NONE}"
    echo "${GREEN}URL: https://${project}.ddev.site${NONE}"
}

# -------- Main --------

if [ -z "$1" ]; then
    echo "Usage: phpcreate <project-name>"
    exit 1
fi

create_project "$1"
